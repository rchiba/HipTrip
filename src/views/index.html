<html>
<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>HipTrip</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/bootstrap/css/bootstrap.css" rel="stylesheet">
        <style>
          body {
            padding-top: 40px; /* 60px to make the container go all the way to the bottom of the topbar */
          }
        </style>
        <link href="/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
		<style>
			#heatmapArea {
				position:relative;
				float:left;
				width:100%;
				height:100%;
				border:0px dashed black;
			}
			#configArea {
				position:absolute;
				top:60px;
                right:30px;
				width:310px;
                background-color:#fff;
				padding:15px;
                opacity:.9;
                background-image:url(/img/grid_noise.png);
                border: 1px solid #999;
                overflow-y:scroll;
                height:85%;
			}
            
            .yelp{
                width:100%;
                height:100px;
                background-color:#ccc;
            
            }
            
            #loader{
                width:100px;
                height:100px;
                background-color:#ace400;
                margin-left:auto;
                margin-right:auto;
                opacity:1;
            }
            
            #businessName{
                top:10px;
                font-weight:bold;
                font-size:29px;
                line-height:36px;
                width:185px;
                height:110px;
            }
            
            
            #businessImage{
                position:absolute;
                top: 15px;
                right:15px;
            }
            
            .tweetContainer{
                margin-top:10px;
                padding-bottom:5px;
            }
            
            .tweetUsername{
                width:230px;
                overflow:hidden;
                height:20px;
                font-size:13px;
                margin-left:50px;
                font-weight:bold;
                position:relative;
            }
            
            .linkedBadge{
                background-color:green;
                width:44px;
                font-size:10px;
                height:16px;
                color:white;
                text-align:center;
                position:absolute;
                top:0px;
                right:0px;
                
            }
            
            .tweetImage{
                height:40px;
                width:40px;
                margin-top:-18px;
                border: 1px solid #ccc;
            }
            
            .tweetContents{
                width:255px;
                margin-left:50px;
                margin-top:-26px;
                font-size:12px;
            }
            
            
		</style>
<!--<link rel="shortcut icon" type="image/png" href="http://www.patrick-wied.at/img/favicon.png" />-->


</head>
<body>
    <!-- Navbar -->
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container" style="width:80%">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">HipTrip</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li class="topBtn" id="losAngeles"><a href="#" >Los Angeles</a></li>
              <li class="active topBtn" id="sanFrancisco"><a href="#" >San Francisco</a></li>
              <li class="topBtn" id="greece"><a href="#" >Greece</a></li>
            </ul>
            
            <div class="navbar-search pull-left">
                <input type="text" class="search-query span2" placeholder="Search" style="height:27px; margin-left:50px;" id="search">
            </div>
            
            <ul class="nav pull-right">
              <li ><a data-toggle="modal" href="#aboutModal">About</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>
    
    <!-- Page -->
    <div class="container" style="width:100%">

        <div id="heatmapArea">
            
        </div>
        <div id="configArea">
            <div id="businessName"></div>
            <div id="businessImage"></div>
            <div id="businessRatings">
            <h4>Hipness</h4>
            <div class="progress">
              <div class="bar" style="width: 60%;" id="hipnessBar"></div>
            </div>
            <h4>Yelp Rating</h4>
            <div class="progress">
              <div class="bar" style="width: 60%;" id="yelpBar"></div>
            </div>
            
            <h4>Photos</h4>
            <div id="businessPhotos">
            </div>
            <br />
            
            <h4>Tweets</h4>
            <div id="businessTweets">
            </div>
            <br />
            
            <!--
            <h4>Overlays</h4>
            <div class="btn-group" data-toggle="buttons-checkbox">
                <button id="heatmapLocalsToggle" class="btn btn-primary">Locals</button>
                <button id="heatmapTouristsToggle" class="btn btn-primary">Tourists</button>
                <button id="heatmapFlickrToggle" class="btn btn-primary">Flickr</button>
                <button id="heatmapTwitterToggle" class="btn btn-primary active">Twitter</button>
                <button id="poiToggle" class="btn btn-primary">HipTips</button>
            </div>
            -->
            
        </div>

        
        <div class="modal hide fade" id = "aboutModal" style="display:none">
          <div class="modal-header">
            <a class="close" data-dismiss="modal">×</a>
            <h3>About HipTrip</h3>
          </div>
          <div class="modal-body">
            <p>When traveling, there are many existing services that provide reviews to help travelers decide where to dine, shop, or explore. However, distinguishing between places that tourists frequent and places that locals frequent is a challenge that continues to elude review services. In this paper, we present HipTrip, a system that utilizes geo-spatial data from various public sources to determine tourist “hotspots”, and finds highly rated points of interest away from these areas. This application utilizes Semantic Web technology, knowledge bases, and information extraction techniques to synthesize traveler behavior and points of interest in order to expose valuable travel suggestions.</p>
          </div>
          <div class="modal-footer">
                
          </div>
        </div>
        
        <div class="modal hide fade" id = "loadingModal" style="display:none;">
          <div class="modal-header">
            <h3>Loading...</h3>
          </div>
          <div class="modal-body">
            <p>Please wait while we load up some data... </p>
          </div>
          <div class="modal-footer">
                
          </div>
        </div>
        
    </div> <!-- /container -->
    
    
			
			

<!-- JS -->
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<!--<script src="/js/OpenLayers.js"></script> Maybe move things locally in future if faster-->
<script type="text/javascript" src="/js/heatmap.js"></script>
<script type="text/javascript" src="/js/heatmap-openlayers.js"></script>

<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery.js"></script>
<script src="/bootstrap/js/bootstrap-transition.js"></script>
<script src="/bootstrap/js/bootstrap-button.js"></script>
<script src="/bootstrap/js/bootstrap-modal.js"></script>
<!--
<script src="/bootstrap/js/bootstrap-collapse.js"></script>
<script src="/bootstrap/js/bootstrap-carousel.js"></script>
<script src="/bootstrap/js/bootstrap-typeahead.js"></script>
<script src="/bootstrap/js/bootstrap-alert.js"></script>

<script src="/bootstrap/js/bootstrap-dropdown.js"></script>
<script src="/bootstrap/js/bootstrap-scrollspy.js"></script>
<script src="/bootstrap/js/bootstrap-tab.js"></script>
<script src="/bootstrap/js/bootstrap-tooltip.js"></script>
<script src="/bootstrap/js/bootstrap-popover.js"></script>
-->
<script type="text/javascript">
var map, layer, heatmaps, markers, losAngeles, sanFrancisco, greece, pois;



function init(){

    console.log('init');
    
    // setup loading modal
    $('#loadingModal').modal({
        backdrop:false,
        keyboard:false,
        show:true});
    
   // setup map
   map = new OpenLayers.Map( 'heatmapArea',{
        sphericalMercator: true,
        maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
        displayProjection: new OpenLayers.Projection("EPSG:4326") // lat lon
   });
   
   // create our heatmap layer 
   layer = new OpenLayers.Layer.OSM();
   
   // Adding heatmap to map
   heatmaps = {};
   heatmaps.twitterHeatmap = new OpenLayers.Layer.Heatmap( "Twitter Heatmap Layer", map, layer, {visible: true, radius:4}, {isBaseLayer: false, opacity: .5, projection: new OpenLayers.Projection("EPSG:4326")});
   map.addLayers([layer, heatmaps.twitterHeatmap]);
   
   
   // defining location coordinates for cities
   var proj = new OpenLayers.Projection("EPSG:4326");
   center = new OpenLayers.LonLat(0, 0);
   losAngeles = new OpenLayers.LonLat(-118.2960, 34.02848);
   sanFrancisco = new OpenLayers.LonLat(-122.4370, 37.7899);
   greece = new OpenLayers.LonLat(24.95748, 35.23076);
   
   // this is required due to internal representation of coordinates being different than lat lon
   losAngeles.transform(proj, map.getProjectionObject());
   sanFrancisco.transform(proj, map.getProjectionObject());
   greece.transform(proj, map.getProjectionObject());
   
   losAngeles.urlString = "la";
   sanFrancisco.urlString = "sf";
   greece.urlString = "greece";
   
   console.log('setting center');
   // set default center to sf
   map.setCenter(sanFrancisco, 13, true, true);
   map.addControl(new OpenLayers.Control.MousePosition());
   console.log('done init');
   
}

window.onload = function(){ 
    init(); 
    bind();
    //ajax('sf');
    renderPOI('sf');
};

function bind(){
    console.log('bind');
    
    function zoomTo(that, location, zoom){
        console.log('zoomTo');
        console.log(location);
        
        // Changing button state
        $('.topBtn').each(function(item){ 
            $(this).removeClass('active');
        });
        that.addClass('active');

        map.setCenter(location, zoom, true, true);
        
        // Loading heatmap data
       
    }
    

    // topbar buttons
    $('#sanFrancisco').click(function(event){
        zoomTo($(this), sanFrancisco, 13);
        ajax('sf');
    });
    $('#losAngeles').click(function(event){
        zoomTo($(this), losAngeles, 12);
        ajax('la');
    });
    $('#greece').click(function(event){
        zoomTo($(this), greece, 12);
    });
    
    $('#search').bind('keypress', search);
    
    /*
    document.getElementById("heatmapLocalsToggle").onclick = function(){
        heatmaps.localsHeatmap.toggle();	
    };
    document.getElementById("heatmapTouristsToggle").onclick = function(){
        heatmaps.touristsHeatmap.toggle();	
    };
    document.getElementById("heatmapFlickrToggle").onclick = function(){
        heatmaps.flickrHeatmap.toggle();	
    };
    document.getElementById("heatmapTwitterToggle").onclick = function(){
        heatmaps.twitterHeatmap.toggle();	
    };
    document.getElementById("poiToggle").onclick = function(){
        markers.toggle();	
    };
    */

}



// Call server for heatmaps
function ajax(place){
    console.log('ajax('+place+')');
    // call for heatmap
    $.ajax({
        url: "/"+place+"/heatmap/twitter",
        cache: false,
        success: function(res){
            //console.log('/sf/heatmap/twitter'+res);
            var testData = JSON.parse(res);
            var transformedTestData = { max: testData.max , data: [] },
            data = testData.data,
            datalen = data.length,
            nudata = [];

            // in order to use the OpenLayers Heatmap Layer we have to transform our data into 
            // { max: <max>, data: [{lonlat: <OpenLayers.LonLat>, count: <count>},.]}

            while(datalen--){
                nudata.push({
                    lonlat: new OpenLayers.LonLat(data[datalen].lon, data[datalen].lat),
                    count: data[datalen].count
                });
            }

            transformedTestData.data = nudata;

          
           heatmaps.twitterHeatmap.setDataSet(transformedTestData);

           $('#loadingModal').modal('hide');
           
        } // END success
    }); // END ajax
   
    
}

// Search for the places and display them when searchbox is used
function search(e){
    var code = e.keyCode || e.which
    if(code == 13){ // enter was pressed
        var query = $(this).val();
        // query database
        $.ajax({
        url: "/"+query+"/poi/search",
        cache: true,
        success: function(res){
            try{
                // save into global (I know this is bad.)
                pois = JSON.parse(res);
                // add each poi into the markers layer
                console.log('/mostlinked returned');
                console.log(pois);
                if(markers != null){
                    markers.destroy();
                }
                markers = new OpenLayers.Layer.Markers( "Markers" );
                map.addLayer(markers);
                
                // Custom marker
                var size = new OpenLayers.Size(21,25);
                var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                var icon = new OpenLayers.Icon('http://localhost:1234/img/marker.png', size, offset);
                
                
                for (var x = 0; x < pois.length; x++) {
                    var poi = pois[x];
                    console.log('adding market at '+poi.loc[0]+', '+poi.loc[1]);
                    var lonLat = new OpenLayers.LonLat( poi.loc[1] , poi.loc[0] ).transform(
                        new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
                        map.getProjectionObject() // to Spherical Mercator Projection
                    );
                    var marker = new OpenLayers.Marker(lonLat);
                    marker.pois = poi;
                    var localIndex = x;
                    marker.events.register('mousedown', marker, markerClick.bind(this,x));
                    markers.addMarker(marker, icon.clone());
                }
                
                
                $('#loadingModal').modal('hide');
            
            } catch(e){
                console.log(e.message);
            }
        } // END success
        }); // END ajax
        
    }
}


// Make all the necessary calls when a marker is clicked
function markerClick(x){
    console.log('markerClick called with ');
    console.log(pois[x]);
    var poi = pois[x];
    var id = poi['id']
    var image = poi['image_url'];
    var name = poi['name'];
    var yelpURL = poi['url'];
    
    $('#businessName').html("<a href='"+yelpURL+"' target='_blank'>"+name+"</a>");
    $('#businessImage').html("<img src='"+image+"' />");
    
    // call the backend for details
    $.ajax({
        url: "/"+id+"/poi/details",
        cache: true,
        success: function(res){
            try{
                details = JSON.parse(res);
                // add each poi into the markers layer
                console.log('/details returned');
                console.log(details);
                
                function clearBox(){
                    $('#businessTweets').html("");
                    $('#businessFlickr').html("");
                }
                clearBox();
                
                function makeDiv(name){
                    var div = $(document.createElement('div'));
                    div.addClass(name);
                    return div;
                }
                
                function addTweet(tweet, isLinked){
                    // construct the page
                    var tweetContainer = makeDiv('tweetContainer');
                    var tweetUsername = makeDiv('tweetUsername');
                    var tweetContents = makeDiv('tweetContents');
                    var tweetImage = makeDiv('tweetImage');
                    
                    tweetUsername.html(tweet['fromUser']);
                    tweetContents.html(tweet['text']);
                    tweetImage.html('img');
                    
                    if(!isLinked){
                        tweetContainer.append(tweetUsername);
                    } else{
                        tweetUsername.append("<div class='linkedBadge'>linked!</div>");
                        tweetContainer.append(tweetUsername);
                    }
                    tweetContainer.append(tweetImage);
                    tweetContainer.append(tweetContents);
                    
                    $('#businessTweets').append(tweetContainer);
                }
                
                function addFlickr(flickr){
                
                }
                
                // iterate through details and place each object in the right place
                // in the right structure
                for(var i = 0; i < details.length; i++){
                    var detail = details[i];
                    var type = detail["type"];
                    if(type == "linkedTweet"){
                        addTweet(detail, true);
                    } else if(type == "nearbyTweet"){
                        addTweet(detail, false);
                    } else if(type == "linkedFlickr"){
                        addFlickr(detail);
                    } else if(type == "nearbyFlickr"){
                        addFlickr(detail);
                    } else if(type == "yelpEntry"){
                        
                        // set the yelp bar
                        var score = detail['rating'];
                        $('#yelpBar').css('width',score/5.0*100+'%');
                        $('#yelpBar').text(score+'/5 stars');
                    } else if(type == "hipness"){
                       var score = detail['value'];
                       $('#hipnessBar').css('width',score+'%');
                       $('#hipnessBar').text(Math.floor(score)+'/100 hipness');
                    }
                    
                }   
                
                
                $('#loadingModal').modal('hide');
            
            } catch(e){
                console.log(e.message);
            }
        } // END success
    }); // END ajax
    
    
}

// Creates the layer for the points of interest
function renderPOI(place){
    console.log('renderPOI('+place+')');
    $.ajax({
        url: "/"+place+"/poi/mostlinked",
        cache: true,
        success: function(res){
            try{
                pois = JSON.parse(res);
                // add each poi into the markers layer
                console.log('/mostlinked returned');
                console.log(pois);
                markers = new OpenLayers.Layer.Markers( "Markers" );
                map.addLayer(markers);
                
                // Custom marker
                var size = new OpenLayers.Size(21,25);
                var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                var icon = new OpenLayers.Icon('http://localhost:1234/img/marker.png', size, offset);
                
                
                
                
                for (var x = 0; x < pois.length; x++) {
                    var poi = pois[x];
                    console.log('adding market at '+poi.loc[0]+', '+poi.loc[1]);
                    var lonLat = new OpenLayers.LonLat( poi.loc[1] , poi.loc[0] ).transform(
                        new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
                        map.getProjectionObject() // to Spherical Mercator Projection
                    );
                    var marker = new OpenLayers.Marker(lonLat);
                    marker.pois = poi;
                    var localIndex = x;
                    marker.events.register('mousedown', marker, markerClick.bind(this,x));
                    markers.addMarker(marker, icon.clone());
                }
                
                
                $('#loadingModal').modal('hide');
            
            } catch(e){
                console.log(e.message);
            }
        } // END success
    }); // END ajax
    
    
    
    
    
    
}






</script>

</html>
